# Spring Security

1. Getting started 
   1. Form-Base Authentication:
      1. By default, Spring Security uses Form-Base Authentication (before any configurations), which gives us simple login and logout forms
      2. How it works: 
         1. Form-based authentication use standard HTML form fields to pass the username and password values to the server via a POST request. The server validates the credentials provided and creates a “session” tied to a unique token stored in a cookie and passed between the client and the server on each http request. If the cookie is invalid or the user is logged out, the server then usually redirects to a login page.
      3. url:8080/login (/login - path to the login page of spring security, username is "user", user password is automatically generated from spring security, it can be found in the terminal console)
      4. url:8080/logout (/logout - logout from the current session)
   2. Basic Authentication:
      1. We can use Basic Authentication which gives us a control over the authentication configuration (we must create configuration class where to specify the authentication rules) 
      2. It has a popup to /login, but does not have /logout form
      3. How Basic Authentication works in (Client <> Server communication):
         1. Client (sends GET Request to the Server)
         2. Server (response to the Client with status 401 Unauthorized)
         3. Client (sends GET Request | Basic64 (base64 encoding) username:password to the Server)
         4. Server (response to the Client with status 200 OK)
         5. Basic Auth uses HTTP header in order to provide the username and password when making a request to a server. The credentials are the base64 encoding *Authorization: Basic Base64-encoded(username:password)*. Unlike Form-Based Authentication, Basic Authentication DO NOT use cookies, which means that there is no concept of a session or logging out a user, which means each request has to carry that header in order to be authenticated.
      4. Configure Web Security:
         1. Class annotations:
            1. \@Configuration (indicates that the class has \@Bean definition methods)
            2. \@EnableWebSecurity (enable web security)
      5. HTTPS recommended
      6. Simple and Fast
      7. Can't log out
      8. Authorization: Basic ZGVtbzpwQDU1dzByZa== 
   3. Main difference between Form-Base Authentication and Basic Auth:
      1. Form-Base Authentication uses cookies to store the data for the user, which means that the user must log in once and after that he can use these cookies as log in credentials, to the time when the cookie is expired or user click logout button, to kill the cookie, or the session on the serverside is expired.
      2. Base Auth on each request must send username and password credentials to the server, server checks for the validity of the credentials and if it is valid sends response 200 OK and the requested data.
      3. Usage of Form-Base and Basic Authentications: In most of the cases, Form-based Authentication is used to authenticate a web browser based client and an API, and Basic Auth is used for authentication between API’s.
   4. Main difference between COOKIES and SESSIONS (Cookies are client-side files that are stored on a local computer and contain user information. Sessions are server-side files that store user information.)
   5. Users Roles and Authorities
      1. Default user (username: user, password: automatically generated by the spring security)
      2. Create own user authentication system (must have):
         1. username (must have)
         2. password (must have and to be encoded, most used encoder is BCryptPasswordEncoder)
         3. role/s (ROLE_NAME) ***optional**
         4. authorities/permissions ***optional** (we can have role ADMIN, which can have permissions for example create, read, write, and delete, and another role for example USER, which can have only permissions to read and write)
         5. and more ... ***optional**
   6. Permission based authentication with annotations
      1. \@PreAuthorize("") can get some of the arguments that are described below
      2. hasRole('ROLE_') hasAnyRole('ROLE_') hasAuthority('permission') hasAnyAuthority('permission')
   7. CSRF (Cross Site Request Forgery) - the action of forging a copy or imitation of a document, signature, banknote, or work of art.
      1. Whe to use CSRF protection: The recommendation is to use CSRF protection for any request that could be processed by a browser by normal users. If you are only creating a service that is used by non-browser clients, you will likely want to disable CSRF protection.
   8. Form Based Authentication:
      1. Username & Password
      2. Standard in most websites 
      3. Form (Full control)
      4. Can log out
      5. HTTPS recommended
      6. Form Based Authentication Path:
         1. Client send (POST username:password)
         2. Server validate credentials, and return status, if it is 200 OK will return also a COOKIE to the Client with name SESSIONID
         3. Client will use SESSIONID to make any request to the Server, by default SESSIONID is valid 30 minutes after inactivity
         4. Server will validate SESSIONID and will return response with status 200 OK and the requested data
         5. Username & Password
         6. Standard in most websites
         7. Forms (Full Control)
         8. Can log out
         9. HTTPS recommended
         10. To view the cookie in Chrome press (F12 to inspect web page, go to Application tab and find Cookies from the left vertical navigation bar)
         11. To store active session fore each instance of the application the session is stored in memory database, another options is to use Postgresql or Redis
         12. Best practice is to store SESSIONS in real database like Postgresql or Redis
         13. If we want to see the username and password of loge-din user we can go to (F12 inspect, click the tab Networks, go to login page form the left vertical navigation bar, in Payload you can see clearly username and password)
         14. If we create Remember Me button we will get remember-me COOKIE unlike other cookies this COOKIE also is stored in database (default storage of this cookie is 2 weeks)
         15. Remember Me cookie contains (username, expiration time, md5 hash of the above two values) it is stored in actual database
         16. The URL that triggers log out to occur (default is "/logout"). If CSRF protection is enabled (default), then the request must also be a POST. This means that by default POST "/logout" is required to trigger a log-out. If CSRF protection is disabled, then any HTTP method is allowed. 
         17. It is considered best practice to use an HTTP POST on any action that changes state (i.e. log out) to protect against CSRF attacks. If you really want to use an HTTP GET, you can use logoutRequestMessage(new AntPathRequestMatcher(logoutUrl, "GET"));
   9. JSON Web Token (JWT is used when we need to log in through multiple different application):
      1. +Fast
      2. +Stateless
      3. +Used across many services
      4. -Compromised Secret Key
      5. -No visibility to logged-in users
      6. -Token can be stolen
      7. It is better when we have multiple applications that uses our application, if the case it is not like this then it is better to use Form-Based Authentication
      8. JTW path:
         1. Client (send the credentials to the server)
         2. Server (validate the credentials and creates and signs token) and sends token to the client
         3. When the client already have the token (he will send it to the server on each request that he made), it doesn't need to send username and password because it is already authenticated and have the token from the server
      9. JWT token is created by (header.payload.verify_signature, asdfhajksdhfjkasdhf.asdfhakshdf.asdfkhas)
      10. Everybody can decode JWT and after that can decode the secured code from base64 
      11. To log in with JTW:
          1. Send POST request to localhost:8080/login endpoint with body { "username" : "SomeUserName", "password" : "SomePassword" }
          2. In the header will receive the response with JWT token for example: "Authorization" : "Bearer eyJhbGciOiJIUzUxMiJ9.eyJzdWIiOiJhZG1pbiIsImF1dGhvcml0aWVzIjpbeyJhdXRob3JpdHkiOiJzdHVkZW50OndyaXRlIn0seyJhdXRob3JpdHkiOiJzdHVkZW50OnJlYWQifSx7ImF1dGhvcml0eSI6ImNvdXJzZTpyZWFkIn0seyJhdXRob3JpdHkiOiJST0xFX0FETUlOIn0seyJhdXRob3JpdHkiOiJjb3Vyc2U6d3JpdGUifV0sImlhdCI6MTY2NjUwNzA4OSwiZXhwIjoxNjY3Njg1NjAwfQ.Aaaq9vptavB2wqgIE4Clce-8zgOa7Wy5Nw-1Fhov2rARZ-OK8DG65VqwWOXOcOYiW04mGAUphBmIVL-N9mAWZw"
          3. Which can be decoded in https://jwt.io/ website
          4. Send JWT token in each request in the Header of the request write ("Authorization": "Bearer eyJhbGciOiJIUzUxMiJ9.eyJzdWIiOiJhZG1pbiIsImF1dGhvcml0aWVzIjpbeyJhdXRob3JpdHkiOiJzdHVkZW50OndyaXRlIn0seyJhdXRob3JpdHkiOiJzdHVkZW50OnJlYWQifSx7ImF1dGhvcml0eSI6ImNvdXJzZTpyZWFkIn0seyJhdXRob3JpdHkiOiJST0xFX0FETUlOIn0seyJhdXRob3JpdHkiOiJjb3Vyc2U6d3JpdGUifV0sImlhdCI6MTY2NjUwNzA4OSwiZXhwIjoxNjY3Njg1NjAwfQ.Aaaq9vptavB2wqgIE4Clce-8zgOa7Wy5Nw-1Fhov2rARZ-OK8DG65VqwWOXOcOYiW04mGAUphBmIVL-N9mAWZw")
      12. It is important to create JWT tokens with short expiration date (for example 10 - 7 days)
      13. To prevent user to create multiple tokens is good practice to store some information of the user and the token in the database. So if the user request another token we can invalidate the previous token.